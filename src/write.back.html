<?
require_once $_SERVER['DOCUMENT_ROOT'] . '/INI.html';
require_once $_SERVER['DOCUMENT_ROOT'] . '/common/login_checkMgn.html';

require_once $_SERVER['DOCUMENT_ROOT'] . "/boardProc/config/bbs_config.html";
if(!$writeFlag) getLink("list.html?code=$code&c_code=$c_code", '권한이 없습니다.');

global $G_DB;
$db = new DBConn($G_DB);

$page = 1;
$PHP_SELF = $_SERVER['PHP_SELF'] ?? "";
$keyfield = $keyfield ?? "";
$search_code = "";
$uid = "";
$ruid = "";
$email = "";
$name = "";
$hp = "";

//extract($_REQUEST, EXTR_OVERWRITE); 

$uid = $_REQUEST['uid'] ?? "";
$ruid = $_REQUEST['ruid'] ?? "";
$code = $_GET['code'] ?? "";

if($uid) {
	$query = "SELECT * FROM bbs WHERE code=? AND uid=?";
	$edit = $db->fetch($query, [$code, $uid]);

	$date = date("m/d", $edit['signdate']);
	$name = $edit['name'];
	$email = $edit['email'];
	$hp = $edit['hp'];
	$subject = stripslashes($edit['subject']);
	$comment = stripslashes($edit['comment']);
	$security = $edit['security'];
	$notice = $edit['notice'];
	$orderNo = $edit['orderNo'] ?? "";
	$hotImage = $edit['hotImage'] ?? "";
	$dbpws = "<input type=\"hidden\" name=\"uid\" value=\"$_GET[uid]\"><input type=\"hidden\" name=\"page\" value=\"$page\">";

	$c_code = $edit['c_code'];

	$mode = "mod";
	$modeStr = "수정";
} elseif($ruid) {
    $query = "SELECT * FROM bbs WHERE code=? AND uid=?";
	$edit = $db->fetch($query, [$code, $ruid]);

	$date = date("m/d",$edit['signdate']);
	$subject = stripslashes($edit['subject']);
	$comment = stripslashes($edit['comment']);
	$subject = preg_replace('/^\[RE\]\s*/i', '', $subject);
	$subject = "[RE] ".$subject;
	$comment = ":" . $comment;
	$comment = str_replace("\n", "\n:", $comment);

	$comment = "---------------------".$edit['name'] . "님의 글입니다.---------------------\n\n" . $comment . "\n";

	$dbpws = "<input type=\"hidden\" name=\"uid\" value=\"$_GET[uid]\"><input type=\"hidden\" name=\"page\" value=\"$page\"><input type=\"hidden\" name=\"fid\" value=\"$edit[fid]\"><input type=\"hidden\" name=\"thread\" value=\"$edit[thread]\">";

	$mode = "reply";
	$modeStr = "답변";
} else {
	$edit['m_flag'] = 1;

	$mode = "add";
	$modeStr = "등록";
}

$query = "select * from Mbr_Members where MB_ID=?";
$memberInfo = $db->fetch($query, [$LM_ID]);

if(!$email) $email = $memberInfo['MB_EMAIL'];
//if(!$name) $name = $memberInfo['MB_NIC'];
if(!$name) $name = $memberInfo['MB_NAME'];
if(!$hp) $hp = $memberInfo['MB_HAND_TEL'];
$arrHp = explode("-", $hp);

if(!empty($searchText)) {
	$search_code .= "&searchKey=" . urlencode($searchKey);
	$search_code .= "&searchText=" . urlencode($searchText);
}
if(!empty($c_code)) {
	$search_code .= "&c_code=" . urlencode($c_code);
}
$search_code .= "&code=" . urlencode($code);
$search_code .= "&page=" . urlencode($page);

if($BBS['carInputFlag']) {
	require_once $_SERVER['DOCUMENT_ROOT'] . '/common/class/class.car.php';
	if($mode != "add") {
		$editCompany = cMakerString($edit['bm_no']);
		$editModel = cModelString($edit['bo_no']);
		$editSeries = cSeriesString($edit['bs_no']);
	}
}

$topMenuMainMenuKey = 3;
$topMenuSubMenuKey = 1;
$topMenuLeftMenuKey = 0;
$serverCode = $code;
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title><?=$GINIT['title']?></title>
<? include $_SERVER['DOCUMENT_ROOT'] . "/Adm/common/include/head.html"; ?>


<script type="text/javascript" src="/se/js/HuskyEZCreator.js" charset="utf-8"></script>
<SCRIPT LANGUAGE="JavaScript">
<!--
function formCheck(f) {
	if(!f.subject.value) {
		alert("제목을 입력하세요.");
		f.subject.focus();
		return false;
	}
	oEditors.getById["TxtContent"].exec("UPDATE_CONTENTS_FIELD", []);	// 에디터의 내용이 textarea에 적용됩니다.
}
//-->
</SCRIPT>
<?
// 에디터 코드 삽입
include_once($_SERVER['DOCUMENT_ROOT'].'/boardProc/gmEditor/func_editor.php');
?>
</head>

<body> 
<div class="subWrap">
<? include $_SERVER['DOCUMENT_ROOT'] . "/Adm/common/include/header.html"; ?>
	<div class="container">
<!-- [s]subMenu -->
		<? include "menu.html"; ?>
<!-- [e]subMenu -->
<!-- [s]content -->
		<div class="content">
			<div class="navi"><img src="/Adm/image/sub/icon_home.gif"><span>&gt;</span><?=$BBS['dMenu']?><span>&gt;</span><?=$BBS['title']?></div>
			<h1 class="title"><?=$BBS['title']?> <?=$modeStr?></h1>

			<div class="card">
				<div class="subtitle">정보 입력</div>
				<div class="list_wrap">
<!-- [s]기업정보 -->
<IFRAME NAME='processIframe' SRC='' WIDTH=0 HEIGHT=0 FRAMEBORDER=0 SCROLLING=NO></IFRAME>
<form name="writeForm" method="post" action="/boardProc/board_ok.html" onsubmit="return formCheck(this);" enctype="multipart/form-data">
<input type="hidden" name="code" value="<?=$serverCode?>">
<input type="hidden" name="url" value="<?=$PHP_SELF?>">
<input type="hidden" name="security" value="0">
<input type="hidden" name="mode" value="<?=$mode?>">
<input type="hidden" name="location" value="Mgn">
<?=$dbpws ?? ''?>
			
				<table width="100%" border="0" cellspacing="0" cellpadding="0" class="t_from">
				 	<colgroup>
						<col width="100" />
						<col width="410" />
						<col width="100" />
						<col />
					</colgroup>
<?if($BBS['carInputFlag']) {?>
					<tr>
						<th>차종선택</th>
						<td colspan="3">

<select name="company" onChange="setModelCode('', 'writeForm');" style="width:100px">
<option value="">제조사 선택</option>
</select>
<select name="c_name" onChange="setSeriesCode('', 'writeForm');" style="width:120px">
<option value="">모델 선택</option>
</select>
<select name="series" style="width:170px">
<option value="">등급 선택</option>
</select>

						</td>
					</tr>
<?}?>


					<tr>
						<th>제목</th>
						<td colspan="3">
						<input type="text" name="subject" value="<?=$subject ?? ''?>" size="60" />
						</td>
					</tr>
<?if($BBS['selectFlag'] ?? ''){?>
					<tr>
						<th>구분</th>
						<td colspan="3">
<select name="c_code">
	<option value="">선택하세요</option>
<?
for($i = 0; $i < count($BBS['aSelectColumn']); $i ++)
{
	$key = $BBS['aSelectColumn'][$i];
	$text = SearchArray($cCodeDirect, $key, 1, '');
	if($c_code == $key) $sel = "selected";
	else $sel = "";

	echo "<option value='" . $key . "' $sel>" . $text . "</option>";
}
?>
</select>
						</td>
					</tr>
<?}?>
					<tr>
						<th>작성자</th>
						<td class="m">
						<input type="text" name="name" value="<?=$name?>" />
						<INPUT TYPE="hidden" NAME="id" value="<?=$LM_ID?>">
						<INPUT TYPE="hidden" NAME="passwd" value="<?=$memberInfo['MB_PW']?>">
						</td>
						<th>이메일</th>
						<td>
						<input type="text" name="email" value="<?=$email?>" size="40" />
						</td>
					</tr>
					<tr>
						<th>연락처</th>
						<td colspan="3">
						<input name="hp1" value="<?=$arrHp[0]?>" type="text" style="width:50px;" /> -
						<input name="hp2" value="<?=$arrHp[1]?>" type="text" style="width:50px;" /> -
						<input name="hp3" value="<?=$arrHp[2]?>" type="text" style="width:50px;" />
						</td>
					</tr>
					<tr>
						<th>공개여부</th>
						<td class="m">
						<input type=checkbox name='security' id="securityY" value="1" <?if(($edit['security'] ?? '')=='1') echo " checked";?> class="noInput"><label for="securityY"></label>
						<font color="#3366CC"><span class="size8">체크를 하시면 작성자와 관리자만 글을 볼 수 있습니다.</span></font>
						</td>
						<th>공지사항</th>
						<td>
						<input type=checkbox name='notice' id="notice" value="Y" <?if(($notice ?? '')=='Y') echo " checked";?>><label for="notice"></label>
						<font color="#3366CC"><span class="size8">체크를 하시면 게시판 상단에 표시됩니다.</span></font>
						</td>
					</tr>
					<tr>
						<th>내용</th>
						<td colspan="3" style="padding-right:10px;" class="none">
							<textarea name="TxtContent" id="TxtContent" style="width:100%;height:300px;"><?=$comment ?? ''?></textarea>
						</td>
					</tr>
<?if($BBS['fileCount'] ?? '') {?>
					<tr>
						<th>파일</th>
						<td colspan="3">
<?
if($mode != "mod") $edit['frontImagePos'] = 1;
$aFilename = "";
if(!empty($edit['filename'])){
	$aFilename = explode("##", $edit['filename']);
}
$style = "";
$tFile = "";
for($i=1;$i<=$BBS['fileCount'];$i++)
{
	if($mode=="mod")
	{
		$tFile = isset($aFilename[$i]) ? $aFilename[$i] : "";
	}
		if($tFile){
			$style = "";
		}else{
			$style = "none";
		}
		if($i == 1)
			$style = "";
?>

<div id="fileDiv_<?=$i?>" style="display:<?=$style?>">
<input type="radio" name="frontImagePos" id="frontImagePos_<?=$i?>" value="<?=$i?>" <?if($edit['frontImagePos'] == $i) echo "checked";?> /><label for="frontImagePos_<?=$i?>" value="<?=$i?>">대표</label>
<input type="file" name="filename<?=$i?>" size="40" class="text_form"><INPUT TYPE="hidden" name="filetemp<?=$i?>" value="<?=$tFile?>"><?if($tFile){?><br> &nbsp; 기존파일 : <?=$tFile?> (삭제하려면 체크하세요 : <INPUT TYPE="checkbox" name="filecheck<?=$i?>" value="Y">)<?}?></div>
<?
}
?>
											파일갯수 <font style="cursor:pointer" onclick="fileMinus()">▲</font><font style="cursor:pointer" onclick="filePlus()">▼</font>
<br />
업로드 파일중 대표로 선택한 파일이 리스트에 노출됩니다.
						</td>
					</tr>
<?}?>
				</table>
				</div><!-- .list_wrap -->
            <div class="footerFix">
				<div class="button_wrap center">
					<button type="button" value="취소" onclick="history.back();" class="button" />취소</button>
					<button type="submit" value="저장" class="button btn_primary"/>저장</button>
				</div>
			</div><!-- .footerFix -->
</form>
<!-- [e]기업정보 -->



		</div><!--.card  -->
	</div><!-- .content -->
</div><!-- .container -->

<script type="text/javascript">
var oEditors = [];

// 추가 글꼴 목록
//var aAdditionalFontSet = [["MS UI Gothic", "MS UI Gothic"], ["Comic Sans MS", "Comic Sans MS"],["TEST","TEST"]];

nhn.husky.EZCreator.createInIFrame({
	oAppRef: oEditors,
	elPlaceHolder: "TxtContent",
	sSkinURI: "/se/SmartEditor2Skin.html",	
	htParams : {
		bUseToolbar : true,				// 툴바 사용 여부 (true:사용/ false:사용하지 않음)
		bUseVerticalResizer : true,		// 입력창 크기 조절바 사용 여부 (true:사용/ false:사용하지 않음)
		bUseModeChanger : true,			// 모드 탭(Editor | HTML | TEXT) 사용 여부 (true:사용/ false:사용하지 않음)
		//aAdditionalFontList : aAdditionalFontSet,		// 추가 글꼴 목록
		fOnBeforeUnload : function(){
			//alert("완료!");
		}
	}, //boolean
	fOnAppLoad : function(){
		//예제 코드
		//oEditors.getById["ir1"].exec("PASTE_HTML", ["로딩이 완료된 후에 본문에 삽입되는 text입니다."]);
	},
	fCreator: "createSEditor2"
});
</script>

<? include $_SERVER['DOCUMENT_ROOT'] . "/Adm/common/include/footer.html"; ?>


</div><!--  .subWrap-->
</body>
</html>
