<?
require_once $_SERVER['DOCUMENT_ROOT'] . '/INI.html';
require_once $_SERVER['DOCUMENT_ROOT'] . '/common/login_checkMgn.html';

require_once $_SERVER['DOCUMENT_ROOT'] . "/boardProc/config/bbs_config.html";

global $G_DB;
$db = new DBConn($G_DB);

$search_code = "";
$sql = "";
$sql_param = [];
$page = 1;
$searchKey = "";
$number = 0;
$cCodeDirect = [];
$PHP_SELF = $_SERVER['PHP_SELF'] ?? "";
//$code = $_REQUEST['code'];
$req = $_POST + $_GET;            // POST 우선 병합(쿠키 배제)
//extract($req, EXTR_OVERWRITE);
$code = $_GET['code'] ?? $_POST['code'] ?? "";
$searchText = $_GET['searchText'] ?? $_POST['searchText'] ?? "";
$searchKey = $_GET['searchKey'] ?? $_POST['searchKey'] ?? "";
$c_code = $_GET['c_code'] ?? $_POST['c_code'] ?? "";

if(!empty($searchText)) {
	$sql .= "and {$searchKey} like '%{$searchText}%' ";
	$search_code .= "&searchKey=" . urlencode($searchKey);
	$search_code .= "&searchText=" . urlencode($searchText);
}

if(!empty($c_code)) {
	$sql .= "and c_code = ? ";
	$sql_param[] = $c_code;
	$search_code .= "&c_code=" . urlencode($c_code);
}

$search_code .= "&code=" . urlencode($code);
$search_code .= "&topMenuMainMenuKey=" . ($_GET['topMenuMainMenuKey'] ?? 3);
//////////////////////// 반드시 처리해야하는 부분
$sql .= " and code=? ";
$sql_param[] = $code;
//////////////////////// 반드시 처리해야하는 부분

$list_c_query = "select count(*) from bbs where 1 $sql"; 
//echo $list_c_query;

$total = getValues($db, $list_c_query, 0, $sql_param);
if(!$page) $page = 1;
$pgsize = 20;
$total_page  = ceil($total/$pgsize);
if($total == 0) {
	$first = 0;
	$last = 0;
} else {
	$first = $pgsize*($page-1);
	$last = $pgsize*$page;
}

$num = $total - $pgsize*($page-1);
if($code == "faq"){
	$listQuery = "SELECT * FROM bbs where 1 $sql ORDER BY fid ASC, thread ASC LIMIT $first, $pgsize";
}else{
	$listQuery = "SELECT * FROM bbs where 1 $sql ORDER BY fid DESC, thread ASC LIMIT $first, $pgsize";
}
//echo $list_query;
$listResult = $db->fetchAll($listQuery, $sql_param);

if($BBS['carInputFlag']) {
	require_once $_SERVER['DOCUMENT_ROOT'] . '/common/class/class.car.php';
}

$topMenuMainMenuKey = $_GET['topMenuMainMenuKey'] ?? 3;
$topMenuSubMenuKey = 1;
$topMenuLeftMenuKey = 0;

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<? include $_SERVER['DOCUMENT_ROOT'] . "/Adm/common/include/head.html"; ?>
<SCRIPT LANGUAGE="JavaScript">
<!--
function sel_delete() {
	var que = chk_check();
	if (que == '') {
		alert('게시글이 선택되지 않았습니다.  ');
		return false;
	}
	if (!confirm('\n정말로 삭제하시겠습니까?     \n')) {
		return false;
	}
	processIframe.location.href = "/boardProc/board_ok.html?mode=multi_delete&location=Mgn&duid=" + que + "<?=$search_code?>";
}
//-->
</SCRIPT>
</head>

<body> 
<div class="subWrap">
<? include $_SERVER['DOCUMENT_ROOT'] . "/Adm/common/include/header.html"; ?>
	<div class="container">
<!-- [s]subMenu -->
		<? include "menu.html"; ?>
<!-- [e]subMenu -->
<!-- [s]content -->
		<div class="content">
			<div class="navi"><img src="/Adm/image/sub/icon_home.gif"><span>&gt;</span><?=$BBS['dMenu']?><span>&gt;</span><?=$BBS['title']?></div>
			<h1 class="title"><?=$BBS['title']?></h1>

<form name='form' method='GET' action=''>
<INPUT TYPE="hidden" NAME="_searchFlag" VALUE="1">
<div class="card requestBox">
	<div class="search_wrap center">
        <div class="row_wrap">	
			<span>
					<select name="searchKey" class="w100">
						<option value="subject" <?if($searchKey == "subject") echo " selected"?>>제목</option>
						<option value="comment" <?if($searchKey == "comment") echo " selected"?>>내용</option>
					</select>
					</span>
					<span><input name="searchText" value="<?=$searchText ?? ''?>" type="text"  class="w250"/></span>	
		</div>	
		<div class="btn_wrap"><input type="button" value="검색" onclick="chkSearchForm();" /></div>
	</div><!-- .search_wrap -->	
</div><!--  .card -->
</form>


   <div class="card card_margin">
			<div class="box_filters">
			<div class="totalNum">
				Total <strong><?=$total?></strong>
				<span class="btn_default"><input type="button" value="삭제" onclick="sel_delete();" /></span>
				
			</div>
			<button type="button" value="등록" onclick="location.href = 'write.html?code=<?=$_GET['code']?>&topMenuMainMenuKey=<?=$_GET['topMenuMainMenuKey'] ?? 3?>';" class="btn_basic btn_primary btn_write"/>등록</button>
           </div><!-- .box_filters  -->
          <div class="title_fixed">
			<table width="100%" class="t_list">
				<colgroup>
					<col style="width:30px"/>
<?if($BBS['selectFlag'] ?? ''){?>
					<col style="width:70px"/>
<?}?>
					<col style="*"/>
					<col style="width:120px"/>
					<col style="width:130px"/>
					<col style="width:60px"/>
				</colgroup>
				<tr>
                    <th><input type="checkbox" name="checkbox22" id="toggle_checked_status" onfocus='this.blur()' onclick="select_que_all();" border="0"><label for="toggle_checked_status"></label></th>
<?if($BBS['selectFlag'] ?? ''){?>
					<th>구분</th>
<?}?>
					<th>제목</th>
					<th>작성자</th>
					<th>작성일</th>
					<th>조회</th>
				</tr>
			</table>
		  </div><!-- .title_fixed -->

		  <div class="list_wrap">
			<table width="100%" class="t_list type2">
				<colgroup>
					<col style="width:30px"/>
<?if($BBS['selectFlag'] ?? ''){?>
					<col style="width:70px"/>
<?}?>
					<col style="*"/>
					<col style="width:120px"/>
					<col style="width:130px"/>
					<col style="width:60px"/>
				</colgroup>
				
<?
$bgcolor = "#FFFFFF";
$i=0;
foreach($listResult as $list) {
	$listNo = $list['uid'];
	$listRegDate = date("Y.m.d",$list['signdate']);
	$my_ref = $list['ref'];
	$my_thread = $list['thread'];
	$my_subject = "";
	$my_newIcon ="";
	$my_subject = $list['subject'];
	$my_subject = stripslashes($my_subject);

	$my_subject = str_cut($my_subject, 50);
	$link = "<a href='view.html?uid=$listNo&page=$page$search_code'>";

	$indentStr = "";
	$spacer = strlen($my_thread) - 1;
	if($spacer > $reply_indent) $spacer = $reply_indent;
	for($j = 0; $j < $spacer; $j++) {
		$indentStr .= "&nbsp; ";
	}

	$date_diff = time() -  $list['signdate'];
	if ($number == ($list['uid'] ?? '')) {
		$indentStr .= ("<font color=red>*</font>");
	} else {
		if(!strcmp($my_thread,"A")) {
			$indentStr .= ("&nbsp;");
		} else {
			$indentStr .= ("▶ ");
		}
	}

	$cmtSum = getValues($db, "select count(*) from bbsTxt where pnum=? and pcode=?", 0, [$listNo, $code]);
	if($cmtSum == 0) $cmtSumStr = "";
	else $cmtSumStr = "<font color=#ff9900>[$cmtSum]</font>";

	if($list['email']) $nameStr = "<a href=\"mailto:$list[email]\">" . str_cut($list['name'], 8) . "</a>";
	else $nameStr = str_cut($list['name'], 8);

	$fileCheck = strlen(str_replace("##", "", $list['filename']));

	if(is_array($cCodeDirect)) {
		$cCodeStr = SearchArray($cCodeDirect, $list['c_code'], 1, '');
	} else {
		$cCodeStr = $list['c_code'];
	}

	if($list['notice'] == "Y") $noticeStr = "<font color='red'>[공지]</font>";
	else $noticeStr = "";

	$addSubjectCar = "";
	if($BBS['carInputFlag']) {
		$listCompany = cMakerString($list['bm_no']);
		$listModel = cModelString($list['bo_no']);
		$listSeries = cSeriesString($list['bs_no']);
		$addSubjectCar = "<span style='color:blue; padding-right:10px;'>[{$listCompany}] {$listModel} {$listSeries}</span>";
	}

?>
				<tr bgcolor="<?=$bgcolor?>">
					<td align="center"><input type=checkbox name="chk[]" id="chk_<?=$i?>" value='<?=$listNo?>'><label for="chk_<?=$i?>"></label></td>
<?if($BBS['selectFlag'] ?? ''){?>
					<td align="center"><?=$cCodeStr?></td>
<?}?>
					<td align="left"><strong><?=$indentStr . $addSubjectCar . $link . $my_subject?></a></strong> <?=$my_newIcon . $cmtSumStr?> <?=$noticeStr?></td>
					<td align="center"><?=$nameStr?></td>
					<td align="center"><?=$listRegDate?></td>
					<td align="center"><?=$my_ref?></td>
				</tr>
<?
	if($bgcolor == "#FFFFFF")
		$bgcolor = "#F5F5F5";
	else
		$bgcolor = "#FFFFFF";
	$num --;
	$i++;
}
?>
			</table>
  </div><!-- .list_wrap -->
<div class="footerFix">
<div class="page">
<?php
$page_per_block = 5;
$total_block = ceil($total_page/$page_per_block);
$block = ceil($page/$page_per_block);

$first_page = ($block-1)*$page_per_block;
$last_page = $block*$page_per_block;

if($total_block <= $block) {
   $last_page = $total_page;
}

echo("<a href=\"$PHP_SELF?page=1$search_code\" class='first'><span>맨처음</span></a>");

if($block > 1) {
	$my_page = $first_page;
	echo("<a href=\"$PHP_SELF?page=$my_page$search_code\" class='first'><span>이전</span></a>");
} else {
	echo("<a href=\"#\" class='prev'><span>이전</span></a>");
}
echo " ";
for($direct_page = $first_page+1; $direct_page <= $last_page; $direct_page++) {
	if($page == $direct_page) {
		echo("<a href=\"$PHP_SELF?page=$direct_page$search_code\" class='on'>$direct_page</a>");
	} else {
		echo("<a href=\"$PHP_SELF?page=$direct_page$search_code\">$direct_page</a>");
	}
	if($direct_page != $last_page) echo " ";
}
echo " ";
if($block < $total_block) {
	$my_page = $last_page+1;
	echo("<a href=\"$PHP_SELF?page=$my_page$search_code\" class='next'><span>다음</span></a>");
} else {
	echo("<a href='#' class='next'><span>다음</span></a>");
}
echo("<a href=\"$PHP_SELF?page={$total_page}$search_code\" class='last'><span>맨뒤</span></a>");
?>
			</div><!-- .page-->
		</div><!-- .footerFix -->
	</div><!-- .card -->

	</div><!-- content -->
</div><!-- [e]container -->

<? include $_SERVER['DOCUMENT_ROOT'] . "/Adm/common/include/footer.html"; ?>
</div><!-- .subWrap -->
</body>
</html>
