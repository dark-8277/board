<?php
session_start();
require_once("common/connect.php");
require_once("common/DBConn.php");

// 1. 주소창의 ?idx=번호를 가져옵니다.
$idx = $_GET['idx'] ?? '';

if (!$idx) {
    echo "<script>alert('잘못된 접근입니다.'); location.href='board_list.php';</script>";
    exit;
}

try {
    $db = new DBConn($G_DB);
    // 2. 기존 글 데이터를 DB에서 한 줄 가져옵니다.
    $view = $db->fetch("SELECT * FROM board_write WHERE idx = ?", [$idx]); //

    // 3. 본인 확인: 로그인한 아이디와 작성자 아이디가 다르면 퇴출
    if (!$view || $_SESSION['user_id'] !== $view['user_id']) {
        echo "<script>alert('수정 권한이 없습니다.'); history.back();</script>";
        exit;
    }
} catch (Exception $e) {
    die("에러 발생: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2>게시글 수정</h2>
    <div class="card p-4">
        <div class="mb-3">
            <label class="form-label">제목</label>
            <input type="text" id="edit_Title" class="form-control" 
                   value="<?php echo htmlspecialchars($view['title']); ?>">
        </div>
        <div class="mb-3">
            <label class="form-label">내용</label>
            <textarea id="edit_Content" class="form-control" rows="10"><?php echo htmlspecialchars($view['content']); ?></textarea>
        </div>
        <div class="text-end">
            <button type="button" class="btn btn-secondary" onclick="history.back()">취소</button>
            <button type="button" class="btn btn-success" onclick="updatePost()">수정완료</button>
        </div>
    </div>
</div>

<script>
function updatePost() {
    const title = $('#edit_Title').val();
    const content = $('#edit_Content').val();

    if (!title || !content) {
        alert("제목과 내용을 입력해주세요.");
        return;
    }

    // board_write.php로 데이터를 보냅니다.
    $.ajax({
        url: 'board_write.php',
        type: 'POST',
        data: {
            idx: '<?php echo $idx; ?>', // 수정할 글 번호 필수 전송
            title: title,
            content: content
        },
        dataType: 'json',
        success: function(res) {
            if (res.code == "0") {
                alert("수정되었습니다.");
                location.href = "show.php?idx=<?php echo $idx; ?>";
            } else {
                alert(res.msg);
            }
        }
    });
}
</script>
</body>
</html>